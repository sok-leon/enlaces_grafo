<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Topología de Red</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #fff; }
    #network { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <h2 style="text-align:center; padding:10px;">Topología de Red (Interfaces y Estado)</h2>
  <div id="network"></div>

  <script>
    let network = null;
    let nodesDataset = new vis.DataSet([]);
    let edgesDataset = new vis.DataSet([]);

    async function loadGraph() {
      try {
        const response = await fetch("/status");  // backend que devuelve el JSON
        const devices = await response.json();

        // --- Crear nodos ---
        const nodes = devices.map(dev => ({
          id: dev.id,
          label: dev.name,
          shape: "circle",
          color: { background: "#2563eb", border: "#1e3a8a" },
          font: { color: "#fff", size: 13 }
        }));

        // --- Crear edges ---
        const edges = [];
        devices.forEach(dev => {
          dev.interfaces.forEach(iface => {
            if (dev.id < iface.to) { // evitar duplicados
              edges.push({
                from: dev.id,
                to: iface.to,
                color: iface.status === "up" ? "green" : "red",
                font: { color: "#fff", size: 13, align: "top" },
                dashes: iface.status === "down"
              });
            }
          });
        });

        // --- Actualizar datasets ---
        nodesDataset.clear();
        edgesDataset.clear();
        nodesDataset.add(nodes);
        edgesDataset.add(edges);

        // --- Inicializar grafo solo la primera vez ---
        if (!network) {
          const container = document.getElementById("network");
          const data = { nodes: nodesDataset, edges: edgesDataset };
          const options = {
            layout: { improvedLayout: true },
            physics: { stabilization: true },
            edges: { smooth: { type: "dynamic" } }
          };
          network = new vis.Network(container, data, options);
        }
      } catch (err) {
        console.error("Error cargando datos:", err);
      }
    }

    // Cargar al inicio
    loadGraph();

    // Refrescar cada 5 segundos
    setInterval(loadGraph, 60000);
  </script>
</body>
</html>
