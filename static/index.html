<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Topología de Red</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #fff; }
    #network { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <h2 style="text-align:center; padding:10px;">Topología de Red (Interfaces y Estado)</h2>
  <div id="network"></div>

  <script>
    async function loadGraph() {
      try {
        const response = await fetch("/status");  // backend FastAPI
        const devices = await response.json();

        // Crear nodos
        const nodes = devices.map(dev => ({
          id: dev.id,
          label: dev.name,
          shape: "circle",
          color: { background: "#2563eb", border: "#1e3a8a" },
          font: { color: "#fff", size: 14 }
        }));

        // Crear edges únicos
        const edges = [];
        const seenLinks = new Set();

        devices.forEach(dev => {
          dev.interfaces.forEach(iface => {
            // clave única del enlace (from-to ordenado)
            const key = [Math.min(dev.id, iface.to), Math.max(dev.id, iface.to)].join("-");
            if (!seenLinks.has(key)) {
              seenLinks.add(key);
              edges.push({
                id: key,  // id único del edge
                from: dev.id,
                to: iface.to,
                label: iface.name,
                color: iface.status === "up" ? "green" : "red",
                font: { color: "#fff", size: 10, align: "top" },
                dashes: iface.status === "down"
              });
            }
          });
        });

        // Dibujar
        const container = document.getElementById("network");
        const data = { 
          nodes: new vis.DataSet(nodes), 
          edges: new vis.DataSet(edges) 
        };
        const options = {
          layout: { improvedLayout: true },
          physics: { stabilization: true },
          edges: { smooth: { type: "dynamic" } }
        };

        new vis.Network(container, data, options);
      } catch (err) {
        console.error("Error cargando datos:", err);
      }
    }

    loadGraph();
  </script>
</body>
</html>
