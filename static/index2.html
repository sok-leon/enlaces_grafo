<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mapa de Sitios</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Crear el mapa sin setView
    const map = L.map('map');

    // Definir límites del estado de Puebla
    const pueblaBounds = [
    [17.8, -99.3], // Suroeste
    [20.9, -96.7]  // Noreste
    ];

    // Ajustar la vista al área de Puebla
    map.fitBounds(pueblaBounds);

    // Limitar el mapa para que no se salga de Puebla
    map.setMaxBounds(pueblaBounds);
    map.setMinZoom(7);  // evita que se aleje demasiado

    // Agregar capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
    }).addTo(map);

    async function loadSites() {
      const response = await fetch('/status');
      const sites = await response.json();

      // limpiar markers viejos
      map.eachLayer(layer => {
        if (layer instanceof L.CircleMarker) {
          map.removeLayer(layer);
        }
      });

      sites.forEach(site => {
        const color = site.status === "UP" ? "green" : "red";
        const marker = L.circleMarker([site.lat, site.lng], {
          color: color,
          radius: 10,
          fillOpacity: 0.8
        }).addTo(map);
        marker.bindPopup(`<b>${site.name}</b><br>${site.ip}<br>Status: ${site.status}`);
      });
    }

    loadSites();
    setInterval(loadSites, 10000); // refresca cada 10s
  </script>
</body>
</html>
